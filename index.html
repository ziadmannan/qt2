<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quran Revision Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        /* (All previous CSS remains the same) */
        :root {
            --primary: #2e7d32;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #333333;
            --subtext: #777777;
            --border: #dddddd;
            --selection-bg: #e8f5e9;
            --header-text: #ffffff;
            --overlay-header: #eeeeee;
            --modal-bg: rgba(0,0,0,0.5);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #4caf50;
                --bg: #121212;
                --card-bg: #1e1e1e;
                --text: #e0e0e0;
                --subtext: #999999;
                --border: #333333;
                --selection-bg: #1b2e1c;
                --header-text: #e0e0e0;
                --overlay-header: #252525;
                --modal-bg: rgba(0,0,0,0.8);
            }
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; }
        header { background: var(--primary); color: var(--header-text); padding: 12px 20px; text-align: center; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.1rem; font-weight: 500; }
        .summary-box { background: var(--card-bg); margin: 15px; padding: 20px; border-radius: 15px; border: 1px solid var(--border); }
        .summary-stats { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9rem; }
        .stat-label { color: var(--subtext); }
        .stat-value { font-weight: bold; color: var(--primary); }
        .progress-container { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }
        .container { max-width: 600px; margin: auto; padding: 0 15px 100px 15px; }
        .surah-wrapper { position: relative; margin-bottom: 12px; overflow: hidden; border-radius: 12px; background: var(--primary); }
        .revise-background { position: absolute; right: 0; top: 0; bottom: 0; width: 100%; color: white; display: flex; align-items: center; justify-content: flex-end; padding-right: 25px; font-weight: bold; }
        .surah-card { background: var(--card-bg); padding: 16px; display: flex; align-items: center; position: relative; z-index: 2; transition: transform 0.1s ease-out; touch-action: pan-y; border: 1px solid var(--border); border-radius: 12px; }
        .surah-num { font-weight: bold; color: var(--primary); margin-right: 15px; width: 25px; }
        .surah-info { display: flex; flex-direction: column; flex-grow: 1; }
        .surah-name { font-size: 1.05em; font-weight: 500; }
        .last-revised { font-size: 0.75em; color: var(--subtext); margin-top: 2px; }
        .button-group { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 15px; z-index: 100; }
        .fab { width: 56px; height: 56px; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); background: var(--primary); transition: transform 0.1s; -webkit-tap-highlight-color: transparent; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); display: none; align-items: center; justify-content: center; z-index: 300; padding: 20px; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: var(--border); color: var(--text); }
        .btn-confirm { background: var(--primary); color: white; }
        #selection-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg); z-index: 200; display: none; flex-direction: column; }
        .selection-header { padding: 15px 20px; background: var(--overlay-header); border-bottom: 1px solid var(--border); }
        #search-input { width: 100%; padding: 10px 15px; border: 1px solid var(--border); border-radius: 20px; margin-top: 10px; box-sizing: border-box; background: var(--bg); color: var(--text); outline: none; }
        .surah-list-scroll { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .selectable-item { padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; }
        .selectable-item.selected { background: var(--selection-bg); border-left: 5px solid var(--primary); }
        .done-btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; float: right; cursor: pointer; }
        .swiping-out { animation: slideOut 0.3s forwards; }
        @keyframes slideOut { to { transform: translateX(-100%); opacity: 0; } }
    </style>
</head>
<body>

<header><h1>Quran Revision Tracker</h1></header>

<div class="summary-box" id="summary-section">
    <div class="summary-stats">
        <div><span class="stat-label">Progress:</span> <span class="stat-value" id="progress-text">0/0</span></div>
        <div><span class="stat-label">Cycle:</span> <span class="stat-value" id="cycle-days">Day 0</span></div>
    </div>
    <div class="progress-container"><div class="progress-fill" id="progress-bar"></div></div>
</div>

<div class="container" id="main-list"></div>

<div class="button-group">
    <button class="fab" id="reset-fab" title="Hold to Restart">⟲</button>
    <button class="fab" onclick="toggleSelectionScreen()">+</button>
</div>

<div class="modal-overlay" id="confirm-modal">
    <div class="modal-content">
        <h3>Restart Cycle?</h3>
        <div class="modal-btns">
            <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn btn-confirm" onclick="executeRestart()">Restart</button>
        </div>
    </div>
</div>

<div id="selection-screen">
    <div class="selection-header">
        <button class="done-btn" onclick="toggleSelectionScreen()">Done</button>
        <h3>Manage List</h3>
        <input type="text" id="search-input" placeholder="Search surahs..." oninput="filterSurahs()">
    </div>
    <div class="surah-list-scroll" id="full-surah-list"></div>
</div>

<script>
    // --- SERVICE WORKER REGISTRATION ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW Registered'))
                .catch(err => console.log('SW Error', err));
        });
    }

    let surahs = [];
    let userData = JSON.parse(localStorage.getItem('hifzData')) || [];
    let cycleStartDate = localStorage.getItem('cycleStartDate') || new Date().toISOString();
    let longPressTimer;

    async function loadSurahData() {
        const response = await fetch('surahs.json');
        surahs = await response.json();
        renderMainScreen();
        renderFullList();
    }

    function updateSummary() {
        const total = userData.length;
        const revised = userData.filter(u => u.revised).length;
        const percent = total > 0 ? (revised / total) * 100 : 0;
        document.getElementById('progress-text').innerText = `${revised} / ${total}`;
        document.getElementById('progress-bar').style.width = `${percent}%`;
        const diffDays = Math.floor(Math.abs(new Date() - new Date(cycleStartDate)) / (1000 * 60 * 60 * 24));
        document.getElementById('cycle-days').innerText = `Day ${diffDays + 1}`;
    }

    function renderMainScreen() {
        updateSummary();
        const container = document.getElementById('main-list');
        container.innerHTML = '';
        const toRevise = surahs.filter(s => {
            const record = userData.find(u => u.id === s.id);
            return record && !record.revised;
        }).sort((a, b) => a.id - b.id);

        if (toRevise.length === 0 && userData.length > 0) {
            container.innerHTML = '<div style="text-align:center; color:var(--subtext); margin-top:40px;"><h3>Cycle Complete!</h3></div>';
            return;
        }

        toRevise.forEach(s => {
            const record = userData.find(u => u.id === s.id);
            const wrapper = document.createElement('div');
            wrapper.className = 'surah-wrapper';
            wrapper.innerHTML = `
                <div class="revise-background">DONE ✓</div>
                <div class="surah-card">
                    <span class="surah-num">${s.id}</span>
                    <div class="surah-info">
                        <span class="surah-name">${s.name}</span>
                        <span class="last-revised">${record.lastDate ? 'Last: ' + record.lastDate : 'New'}</span>
                    </div>
                </div>`;
            setupSwipe(wrapper.querySelector('.surah-card'), s.id);
            container.appendChild(wrapper);
        });
    }

    function setupSwipe(el, id) {
        let startX = 0, currentX = 0;
        el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive: true});
        el.addEventListener('touchmove', e => {
            currentX = e.touches[0].clientX;
            if (currentX - startX < 0) el.style.transform = `translateX(${currentX - startX}px)`;
        }, {passive: true});
        el.addEventListener('touchend', () => {
            if (currentX - startX < -100) {
                el.classList.add('swiping-out');
                setTimeout(() => {
                    const r = userData.find(u => u.id === id);
                    r.revised = true; r.lastDate = new Date().toLocaleDateString('en-GB');
                    saveData(); renderMainScreen();
                }, 300);
            } else el.style.transform = `translateX(0px)`;
        });
    }

    const resetBtn = document.getElementById('reset-fab');
    const startPress = () => { longPressTimer = setTimeout(() => { document.getElementById('confirm-modal').style.display = 'flex'; }, 800); };
    const endPress = () => clearTimeout(longPressTimer);
    resetBtn.addEventListener('touchstart', startPress);
    resetBtn.addEventListener('touchend', endPress);

    function executeRestart() {
        userData.forEach(u => u.revised = false);
        cycleStartDate = new Date().toISOString();
        localStorage.setItem('cycleStartDate', cycleStartDate);
        saveData(); closeModal(); renderMainScreen();
    }

    function toggleSurahSelection(id) {
        const i = userData.findIndex(u => u.id === id);
        if (i > -1) userData.splice(i, 1); else userData.push({id, revised: false, lastDate: null});
        saveData(); renderFullList(document.getElementById('search-input').value);
    }

    function saveData() { localStorage.setItem('hifzData', JSON.stringify(userData)); }
    function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }
    function toggleSelectionScreen() {
        const s = document.getElementById('selection-screen');
        s.style.display = s.style.display === 'flex' ? 'none' : 'flex';
        renderMainScreen();
    }
    function renderFullList(f = '') {
        const container = document.getElementById('full-surah-list');
        container.innerHTML = '';
        surahs.filter(s => s.name.toLowerCase().includes(f.toLowerCase())).forEach(s => {
            const sel = userData.some(u => u.id === s.id);
            const div = document.createElement('div');
            div.className = `selectable-item ${sel ? 'selected' : ''}`;
            div.innerHTML = `<strong>${s.id}.</strong> &nbsp; ${s.name}`;
            div.onclick = () => toggleSurahSelection(s.id);
            container.appendChild(div);
        });
    }
    function filterSurahs() { renderFullList(document.getElementById('search-input').value); }
    window.onload = loadSurahData;
</script>
</body>
</html>