<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quran Revision Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        :root {
            --primary: #2e7d32;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #333333;
            --subtext: #777777;
            --border: #dddddd;
            --selection-bg: #e8f5e9;
            --header-text: #ffffff;
            --overlay-header: #eeeeee;
            --modal-bg: rgba(0,0,0,0.5);
            --undo: #d32f2f;
            --streak-fire: #ff9800;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #4caf50;
                --bg: #121212;
                --card-bg: #1e1e1e;
                --text: #e0e0e0;
                --subtext: #999999;
                --border: #333333;
                --selection-bg: #1b2e1c;
                --header-text: #e0e0e0;
                --overlay-header: #252525;
            }
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow-x: hidden; -webkit-user-select: none; user-select: none; }

        /* Sticky Header Logic */
        .sticky-group { position: sticky; top: 0; z-index: 50; background: var(--bg); }
        header { background: var(--primary); color: var(--header-text); padding: 12px 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.1rem; font-weight: 500; }

        .summary-box { background: var(--card-bg); padding: 12px 15px; border-bottom: 1px solid var(--border); box-shadow: 0 4px 6px -4px rgba(0,0,0,0.1); }
        .summary-stats { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.85rem; }
        .stat-group { text-align: center; flex: 1; }
        .stat-value { font-weight: bold; color: var(--primary); font-size: 1rem; }
        .streak-icon { color: var(--streak-fire); }
        .stat-label { font-size: 0.75rem; color: var(--subtext); display: block; }

        .progress-container { height: 6px; background: var(--border); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s ease; }

        .container { max-width: 600px; margin: auto; padding: 15px 15px 150px 15px; }

        /* Surah Card Styles */
        .surah-wrapper { position: relative; margin-bottom: 12px; overflow: hidden; border-radius: 12px; background: var(--primary); }
        .surah-wrapper.is-revised { background: var(--undo); }
        .swipe-bg { position: absolute; top: 0; bottom: 0; width: 100%; color: white; display: flex; align-items: center; padding: 0 20px; font-weight: bold; font-size: 0.8rem; }
        .bg-left { justify-content: flex-start; }
        .bg-right { justify-content: flex-end; }

        .surah-card {
            background: var(--card-bg); padding: 16px; display: flex; align-items: center;
            position: relative; z-index: 2; border: 1px solid var(--border); border-radius: 12px;
            transition: transform 0.1s ease-out; touch-action: pan-y;
        }
        .surah-card.revised-style { opacity: 0.6; border-style: dashed; }
        .surah-num { font-weight: bold; color: var(--primary); margin-right: 15px; width: 25px; }
        .surah-info { display: flex; flex-direction: column; flex-grow: 1; }
        .surah-name { font-size: 1.05em; font-weight: 500; }
        .last-revised { font-size: 0.75em; color: var(--subtext); margin-top: 2px; }

        /* Themed Quran Link Icon */
        .quran-link {
            padding: 8px;
            color: var(--primary);
            text-decoration: none;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .quran-link:active { background: var(--selection-bg); }

        /* Floating Action Buttons */
        .button-group { position: fixed; bottom: 30px; right: 25px; display: flex; flex-direction: column; gap: 12px; z-index: 100; }
        .fab {
            width: 56px; height: 56px; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer; border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); background: var(--primary);
            transition: transform 0.1s, background 0.2s;
        }
        .fab:active { transform: scale(0.9); }
        #toggle-eye.active { background: #1b5e20; box-shadow: inset 0 2px 5px rgba(0,0,0,0.3); }

        /* Toast Styles */
        #toast {
            visibility: hidden; min-width: 280px; background-color: #323232; color: #fff;
            text-align: center; border-radius: 8px; padding: 16px; position: fixed;
            z-index: 1000; left: 50%; bottom: 30px; transform: translateX(-50%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; justify-content: space-between;
            align-items: center; opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 40px; }
        #toast-undo-btn { color: #ff9800; font-weight: bold; cursor: pointer; margin-left: 20px; text-transform: uppercase; font-size: 0.9rem; }

        /* Overlays */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); display: none; align-items: center; justify-content: center; z-index: 300; padding: 20px; }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; }

        #selection-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--card-bg); z-index: 200; display: none; flex-direction: column; }
        .selection-header { padding: 15px 20px; background: var(--overlay-header); border-bottom: 1px solid var(--border); }
        .sync-section { display: flex; gap: 10px; margin-top: 10px; }
        .sync-btn { background: #4285F4; color: white; border: none; padding: 8px 12px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; flex: 1; }
        #install-btn { background: var(--primary); display: none; }

        @keyframes slideOutLeft { to { transform: translateX(-100%); opacity: 0; } }
        @keyframes slideOutRight { to { transform: translateX(100%); opacity: 0; } }
        .anim-left { animation: slideOutLeft 0.3s forwards; }
        .anim-right { animation: slideOutRight 0.3s forwards; }
    </style>
</head>
<body>

<div class="sticky-group">
    <header><h1>Quran Revision Tracker</h1></header>
    <div class="summary-box">
        <div class="summary-stats">
            <div class="stat-group">
                <span class="stat-value" id="progress-text">0/0</span>
                <span class="stat-label">Progress</span>
            </div>
            <div class="stat-group">
                <span class="stat-value"><span class="streak-icon">üî•</span> <span id="streak-count">0</span></span>
                <span class="stat-label">Streak</span>
            </div>
            <div class="stat-group">
                <span class="stat-value" id="cycle-days">Day 1</span>
                <span class="stat-label">Cycle</span>
            </div>
        </div>
        <div class="progress-container"><div class="progress-fill" id="progress-bar"></div></div>
    </div>
</div>

<div class="container" id="main-list"></div>

<div id="toast">
    <span id="toast-message">Surah Revised</span>
    <span id="toast-undo-btn">UNDO</span>
</div>

<div class="button-group">
    <button class="fab" id="reset-fab" title="Hold to Restart">‚ü≤</button>
    <button class="fab" id="toggle-eye" onclick="toggleShowRevised()" title="Show/Hide Revised">
        <span id="eye-icon">üëÅÔ∏è</span>
    </button>
    <button class="fab" onclick="toggleSelectionScreen()" title="Add Surah">+</button>
</div>

<div class="modal-overlay" id="confirm-modal">
    <div class="modal-content">
        <h3>Restart Cycle?</h3>
        <p style="color:var(--subtext)">This will reset your progress but keep your revision dates.</p>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button style="flex:1; padding:12px; border:none; border-radius:8px; background:var(--border)" onclick="closeModal()">Cancel</button>
            <button style="flex:1; padding:12px; border:none; border-radius:8px; background:var(--primary); color:white; font-weight:bold;" onclick="executeRestart()">Restart</button>
        </div>
    </div>
</div>

<div id="selection-screen">
    <div class="selection-header">
        <button style="float:right; background:var(--primary); color:white; border:none; padding:8px 16px; border-radius:6px;" onclick="toggleSelectionScreen()">Done</button>
        <h3>Manage List</h3>
        <div class="sync-section">
            <button class="sync-btn" id="install-btn" onclick="installPWA()">üì≤ Install App</button>
            <button class="sync-btn" onclick="syncToCloud()">‚òÅÔ∏è Backup</button>
        </div>
        <input type="text" id="search-input" placeholder="Search Surahs..." oninput="filterSurahs()" style="width:100%; padding:10px; margin-top:10px; border-radius:20px; border:1px solid #ddd; outline:none;">
    </div>
    <div id="full-surah-list" style="flex:1; overflow-y:auto; padding:10px;"></div>
</div>

<script>
    // --- PWA INSTALL LOGIC ---
    let deferredPrompt;
    const installBtn = document.getElementById('install-btn');

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'block';
    });

    async function installPWA() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') installBtn.style.display = 'none';
        deferredPrompt = null;
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW Active'));
        });
    }

    // --- APP DATA ---
    let surahs = [];
    let userData = JSON.parse(localStorage.getItem('hifzData')) || [];
    let cycleStartDate = localStorage.getItem('cycleStartDate') || new Date().toISOString();
    let showRevised = false;
    let streakData = JSON.parse(localStorage.getItem('streakData')) || { count: 0, lastDate: null };
    let longPressTimer;
    let toastTimeout;

    async function loadSurahData() {
        try {
            const response = await fetch('surahs.json');
            surahs = await response.json();
            calculateStreak();
            renderMainScreen();
            renderFullList();
        } catch (e) { console.error("Could not load surahs.json"); }
    }

    // --- RENDERING ---
    function renderMainScreen() {
        const total = userData.length;
        const revisedCount = userData.filter(u => u.revised).length;
        document.getElementById('progress-text').innerText = `${revisedCount}/${total}`;
        document.getElementById('progress-bar').style.width = `${total > 0 ? (revisedCount/total)*100 : 0}%`;

        const diff = Math.floor(Math.abs(new Date() - new Date(cycleStartDate)) / (86400000));
        document.getElementById('cycle-days').innerText = `Day ${diff + 1}`;

        const eyeBtn = document.getElementById('toggle-eye');
        const eyeIcon = document.getElementById('eye-icon');
        if (showRevised) {
            eyeBtn.classList.add('active');
            eyeIcon.innerHTML = 'üëÅÔ∏è‚Äçüó®Ô∏è';
        } else {
            eyeBtn.classList.remove('active');
            eyeIcon.innerHTML = 'üëÅÔ∏è';
        }

        const container = document.getElementById('main-list');
        container.innerHTML = '';

        const list = surahs.filter(s => {
            const r = userData.find(u => u.id === s.id);
            return r && (showRevised ? true : !r.revised);
        }).sort((a,b) => a.id - b.id);

        if (list.length === 0 && !showRevised) {
            container.innerHTML = `<div style="text-align:center; color:var(--subtext); margin-top:40px;"><h3>All Revised!</h3><p>Tap the eye to see them.</p></div>`;
        }

        list.forEach(s => {
            const r = userData.find(u => u.id === s.id);
            const wrapper = document.createElement('div');
            wrapper.className = `surah-wrapper ${r.revised ? 'is-revised' : ''}`;

            wrapper.innerHTML = `
                <div class="swipe-bg ${r.revised ? 'bg-left' : 'bg-right'}">
                    ${r.revised ? 'UNDO ‚Ü∫' : 'DONE ‚úì'}
                </div>
                <div class="surah-card ${r.revised ? 'revised-style' : ''}">
                    <span class="surah-num">${s.id}</span>
                    <div class="surah-info">
                        <span class="surah-name">${s.name}</span>
                        <span class="last-revised">${r.lastDate ? 'Last: ' + r.lastDate : 'New'}</span>
                    </div>
                    <a href="https://quran.com/${s.id}" target="_blank" class="quran-link" onclick="event.stopPropagation()">üìñ</a>
                </div>`;

            setupSwipe(wrapper.querySelector('.surah-card'), s.id, r.revised, s.name);
            container.appendChild(wrapper);
        });
    }

    function toggleShowRevised() {
        showRevised = !showRevised;
        renderMainScreen();
    }

    // --- SWIPE & TOAST ---
    function setupSwipe(el, id, isAlreadyRevised, surahName) {
        let startX = 0, currentX = 0;
        el.addEventListener('touchstart', e => { startX = e.touches[0].clientX; el.style.transition = 'none'; }, {passive: true});
        el.addEventListener('touchmove', e => {
            currentX = e.touches[0].clientX;
            let diff = currentX - startX;
            if ((!isAlreadyRevised && diff < 0) || (isAlreadyRevised && diff > 0)) el.style.transform = `translateX(${diff}px)`;
        }, {passive: true});
        el.addEventListener('touchend', () => {
            el.style.transition = 'transform 0.2s ease-out';
            let diff = currentX - startX;
            if (Math.abs(diff) > 100) {
                el.classList.add(diff < 0 ? 'anim-left' : 'anim-right');
                updateStatus(id, diff < 0, surahName);
            } else {
                el.style.transform = `translateX(0px)`;
            }
        });
    }

    function updateStatus(id, status, surahName) {
        setTimeout(() => {
            const r = userData.find(u => u.id === id);
            r.revised = status;
            if (status) {
                r.lastDate = new Date().toLocaleDateString('en-GB');
                updateStreak();
                showToast(surahName, id);
            }
            saveData(); renderMainScreen();
        }, 300);
    }

    function showToast(name, id) {
        const t = document.getElementById("toast");
        document.getElementById("toast-message").innerText = `${name} Revised`;
        document.getElementById("toast-undo-btn").onclick = () => { updateStatus(id, false, name); hideToast(); };
        t.className = "show";
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(hideToast, 5000);
    }

    function hideToast() { document.getElementById("toast").className = ""; }

    // --- STREAK & HELPERS ---
    function calculateStreak() {
        const today = new Date().toDateString();
        if (streakData.lastDate && streakData.lastDate !== today) {
            const yest = new Date(); yest.setDate(yest.getDate()-1);
            if (streakData.lastDate !== yest.toDateString()) streakData.count = 0;
        }
        document.getElementById('streak-count').innerText = streakData.count;
    }

    function updateStreak() {
        const today = new Date().toDateString();
        if (streakData.lastDate !== today) { streakData.count++; streakData.lastDate = today; saveStreak(); }
    }

    function saveStreak() { localStorage.setItem('streakData', JSON.stringify(streakData)); }
    function saveData() { localStorage.setItem('hifzData', JSON.stringify(userData)); }

    const resetBtn = document.getElementById('reset-fab');
    resetBtn.addEventListener('touchstart', () => { longPressTimer = setTimeout(() => { document.getElementById('confirm-modal').style.display = 'flex'; }, 800); });
    resetBtn.addEventListener('touchend', () => clearTimeout(longPressTimer));

    function executeRestart() {
        userData.forEach(u => u.revised = false);
        cycleStartDate = new Date().toISOString();
        localStorage.setItem('cycleStartDate', cycleStartDate);
        saveData(); closeModal(); renderMainScreen();
    }

    function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; }
    function toggleSelectionScreen() {
        const s = document.getElementById('selection-screen');
        s.style.display = s.style.display === 'flex' ? 'none' : 'flex';
        renderMainScreen();
    }

    function renderFullList() {
        const filter = document.getElementById('search-input').value.toLowerCase();
        const container = document.getElementById('full-surah-list');
        container.innerHTML = '';
        surahs.filter(s => s.name.toLowerCase().includes(filter)).forEach(s => {
            const sel = userData.some(u => u.id === s.id);
            const div = document.createElement('div');
            div.style = `padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; ${sel ? 'background:var(--selection-bg); border-left:5px solid var(--primary);' : ''}`;
            div.innerHTML = `<span><strong>${s.id}.</strong> ${s.name}</span> <span>${sel ? '‚úÖ' : '+'}</span>`;
            div.onclick = () => {
                const i = userData.findIndex(u => u.id === s.id);
                if (i > -1) userData.splice(i, 1); else userData.push({id: s.id, revised: false, lastDate: null});
                saveData(); renderFullList();
            };
            container.appendChild(div);
        });
    }

    function filterSurahs() { renderFullList(); }
    function syncToCloud() {
        const dataStr = btoa(JSON.stringify({userData, cycleStartDate, streakData}));
        const shareLink = window.location.href.split('?')[0] + "?data=" + dataStr;
        if (navigator.share) navigator.share({ title: 'Quran Tracker Backup', url: shareLink });
        else prompt("Copy backup link:", shareLink);
    }

    window.onload = loadSurahData;
</script>
</body>
</html>